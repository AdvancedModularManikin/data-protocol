# AMM Configuration Data Model

## Overview
In order to simulate a scenario, modules capable of performing the desired simulation must be present and properly
 configured.
In order for a given Scenario definition to be simulated on a variety of hardware,
 common definitions of module functionality, requirements and configuration must be established.
This document outlines the format for these definitions.

## Capabilities
Capabilities are the logical Unit of Functionality for a given module.
Each distinct function of a module should be broken into a separate Capability where possible.
This not only clearly defines what all a module is capable of,
 but also enables functionality to be configured and monitored independently,
 providing better resilience for modules designed and built this way. 
Module technical definition and configuration is broken down by Capability,
 and modules report their status on a per-Capability basis.

When possible, manufacturers shall use existing Capability descriptions to denote functionality and configuration
 within their modules.
This greatly enhances interoperability and enables re-use of scenario definitions.

#### Capability Definitions
Definitions for capabilities shall be maintained via the [Capability Types Glossary](glossaries/Capability) in this
 code repository.
All definitions shall conform to the XSD schema defined in the [Capabilities Schema](schema/CapabilitiesSchema.xsd)
 with a root tag of `CapabilityGlossaryDefinition`.
Definitions are broken into individual files for ease of updates and understanding, but multiple definitions may be
 combined in a single file when prudent.
 
All glossary definition files shall have XML version & encoding of `<?xml version="1.0" encoding="UTF-8"?>`.

## AMM Standard Version
Derived from [Semantic Versioning](https://semver.org), AMM uses the version numbering scheme: MAJOR.MINOR.PATCH

Version numbers are incremented based on the following:
* MAJOR Version: Changes to IDL / XML Schema, breaking changes to Glossary definitions
* MINOR Version: New entries added to Glossaries
* PATCH Version: Non-breaking changes to Glossary definitions, bug fixes

## Operational Description
All Modules musts publish their Capabilities using the `OperationalDescription` Topic.
The Topic consists of several metadata fields about the module, along with the `capabilities_schema` field,
 which is an XML document describing the Capabilities and configuration options for the Module.

The Module Manager (or other software performing equivalent core functionality) shall subscribe to this
 topic and record the associations between the `module_id` value and the `manufacturer` and `model` values.
The combination of `manufacturer` & `model` is used to associate configurations in the Scenario with connected Modules.
Additionally, the `configuration_version` field is compared to ensure compatibility.
 
### `OperationDescription` Topic fields:

#### `name`
A human friendly short identifier for the Module. Used for user interface displays.

#### `description`
A short paragraph that describes the overall Module. Used for user interface displays.

#### `manufacturer`
The name of the manufacturer. This shall be consistent across Modules from the same manufacturer.

#### `model`
The name of the model of Module. This shall be unique per manufacturer.

#### `serial_number`
An identifier unique to Module hardware. May be empty for purely software Modules.

#### `module_id`
Generated by the Module and shall be unique per module instance.
Used to uniquely identify Module in AMM system.

This field is used as a DDS Topic Key.

#### `module_version`
The version of the Module. Should include both hardware and software versions when applicable.

#### `configuration_version`
The version number of the Module's configuration structure.
This version is updated by the manufacturer in accordance with the principals of
 [Semantic Versioning](https://semver.org). 
This value is used by the Module Manager (or equivalent software) to determine whether a configuration provided by a
 Scenario is compatible with a connected Module of the same `manufacturer` and `model`.

Modules shall be compatible with all configurations that share a MAJOR version number.
Any additional features from newer MINOR version changes should be able to be ignored,
 and any missing values from older MINOR versions should have reasonable defaults.

#### `AMM_version`
The latest version of the AMM standard Module is compatible with.

#### `ip_address`
The Module's IP address.
This is published by Modules in order for AMM-compliant networking equipment to associate a Module with an IP address.

#### `capabilities_schema`
This field shall comply with the [XML Schema](https://www.w3.org/XML/Schema) (version 1.1) defined by
 [CapabilitiesSchema.xsd](schema/CapabilitiesSchema.xsd).

This field shall have XML version & encoding of `<?xml version="1.0" encoding="UTF-8"?>`.

### Capabilities Schema Description
Per the schema, the root element shall be `<CapabilitiesSchema>`.

#### PoE Power Requirement
If powered via PoE `<BaselinePoEPower>` must be the first child element.
`BaselinePoEPower` tag always has only two attributes, `nominal` and `units`.
Together, their value defines how much power the module requires, before any additional capability power requirements.
This is usually the power draw of the embedded CPU.

#### Capability Requirements
Every module must define at least one Capability.
`Capability` tag `type`s and additional attributes shall be defined per the
 [Capabilities Glossary](glossaries/Capability).
`Capability` tags have exactly four (ordered) child elements:
```
<Subscriptions></Subscriptions>
<Publications></Publications>
<Assessments></Assessments>
<Resources></Resources>
```

###### `Subscriptions` & `Publications` Tags
The `Subscriptions` and `Publications` tags contain only child elements defining what topics a module subscribes and
 publishes to.
Child element tag names are identical to the topic names defined by [AMM.idl](schema/AMM.idl).
Element attributes are defined in the [XML Schema Definition](schema/CapabilitiesSchema.xsd).

All child elements of the `Subscriptions` and `Publications` tags take an optional `match` attribute,
 which indicates whether a matched subscriber or publisher is `optional` (default) or `required` for proper module
 operation.
A `required` match indicates that the module capability will not achieve `OPERATIONAL` state without the appropriately
 matching publisher or subscriber.

The `match` attribute is used during Scenario authoring to help ensure that the selected collection of Modules will
 be able to adequately perform the desired simulation.
 
###### `Assessments` Tag
The `Assessments` tag contains only child elements defining Event Records (including Omitted Events) that the module
 may assess.
While modules are not required to assess any Events, assessment is a core component of high-quality education, and,
 thus, a core feature of the AMM standard.
As such, module manufacturers should strive to include assessments as a core component of their modules.

###### `Resources` Tag
The `Resources` tag contains only two types of elements `Requirement` and `Supply`,
 though each may be repeated to indicate which resources are being supplied or consumed.
The element definitions are:
```
<Requirement
  type=”Power, Blood Simulant, Clear Liquid, or Compressed Air”
  nominal=”Rate of fluid draw or power usage during normal operation”
  peak=”Peak fluid draw or power usage, optional attribute”
  unit=”Volume per time unit”
/>
<Supply
  type=”Power, Blood Simulant, Clear Liquid, or Compressed Air”
  capacity=”Fluid supply capacity”
  unit=”Volume per time unit”
/>
```

#### Module Configuration Schema
Finally, any & all configuration for a module is contained in a final (optional) `<Configuration>` tag.
The Configuration tag should either contain binary data (wrapped in either a `<hex>` or `<base64>` tag),
 or contain an XML Schema definition for the available configuration values, if feasible.
This is to enable future software to prompt end users for configuration values.

#### Example Capabilities Schema
A contrived example of a Capabilities Schema document for an IV arm is included in this repository:
[ExampleCapabilitiesSchema.xml](ExampleCapabilitiesSchema.xml).

## Module Configuration
Modules shall publish their current configuration to the `ModuleConfiguration` Topic upon successful connection to an
 AMM system.
Modules shall publish updates to this topic in response to a `SAVE` control.

Modules shall subscribe to this Topic and update their behavior when the Module Manager (or equivalent) 
 publishes updates to this topic with a `module_id` field that matches the `module_id` field published by the Module
 on the `OperationalDescription` Topic.
The Module Manager (or equivalent) shall publish updates to the `ModuleConfiguration` Topic when a user selects a new
 Scenario to load onto an AMM system.

When a Scenario is loaded onto an AMM system, via the Module Manager publishing updated configuration,
 Modules shall update their internal state accordingly, and then hold that state until Simulation Control.
Modules shall also publish updates to the `CapabilityStatus` Topic for all appropriate Capabilities selected by
 the loaded Configuration.

### `ModuleConfiguration` Topic fields:

#### `name`
A human friendly short identifier for the Module. Used for user interface displays.

#### `module_id`
Generated by the Module and shall be unique per module instance.
Used to uniquely identify Module in AMM system.

This field is used as a DDS Topic Key.

#### `educational_encounter`
Generated and assigned by the Module Manager (or equivalent) when a Scenario is loaded.
This value is used to uniquely identify the instance of a Scenario being run.

#### `timestamp`
The time of the last update of this Topic. The value is milliseconds since Unix Epoch. 

#### `capabilities_configuration`
An XML document describing the configuration of the Module.
This field shall have XML version & encoding of `<?xml version="1.0" encoding="UTF-8"?>`.
The root element of the XML document shall be `<Configuration>`, which is derived from the Module's Capability Schema.

## Saving & Loading State
To load a saved state, the Module Manager publishes the exact same Module Configuration data that was recorded in
 response to the `SAVE` control, but with a new Educational Encounter value.
Thus, Modules must serialize their internal state in order to publish that state in response to a `SAVE` control.
This also means the Capabilities Schema for the module should reflect possible state serializations.

# Example Module: IV Arm
### Operational Description
#### Published on boot
* Name: `CREST IV Arm - Left`
* Description: `An AMM compatible left arm that provides a radial pulse and an IV injection site.`
* Manufacturer: `UW CREST https://crest.washington.edu/`
* Model: `“IV Arm - Left`
* Serial Number: `DEV-001-L`
* Module ID: <Module-generated UUID>
* Version: `1.0.0`
* Standard Version: `1.0.0`
* IP: `10.0.0.42`
* Capabilities Schema: [<Example Capabilities Schema>](ExampleCapabilitiesSchema.xml)

### Module Configuration
#### Configuration values published by Module at connection
* Name: `CREST IV Arm - Left`
* Module ID: <Module-generated UUID>
* Educational Encounter: `null`
* Timestamp: `1000000`
* Capabilities Configuration:
```
<?xml version="1.0" encoding="UTF-8"?>
<Configuration>
  <!-- 22734 is the FMAID for left radial artery -->
  <Capability type="Pulse" location="22734">
    <!-- initially disabled -->
    <enable>false</enable>
  </Capability>
  <Capability type="IV Access" location="22734">
    <!-- initially disabled -->
    <enable>false</enable>
    <state>0</state>
  </Capability>
</Configuration>
```
#### Configuration published by Module Manager from Scenario
Happens 41 seconds after startup. Changes highlighted.
* Name: `CREST IV Arm - Left`
* Module ID: [Module-generated UUID]
* *Educational Encounter: [Generated by Module Manager]*
* *Timestamp: 1041000*
```
Capabilities Configuration:
<?xml version="1.0" encoding="UTF-8"?>
<Configuration>
  <!-- 22734 is the FMAID for left radial artery -->
  <Capability type="Pulse" location="22734">
    <!-- enabled by scenario -->
    <enable>true</enable> <!-- Changed to true -->
  </Capability>
  <Capability type="IV Access" location="22734">
    <!-- enabled by scenario -->
    <enable>true</enable> <!-- Changed to true -->
    <state>0</state>
  </Capability>
</Configuration>
```

#### Configuration published by Module after receiving `SAVE` control
Happens 500 seconds after scenario load. Changes highlighted.
* Name: `CREST IV Arm - Left`
* Module ID: [Module-generated UUID]
* Educational Encounter: [Generated by Module Manager]
* *Timestamp: 1541000*
```
Capabilities Configuration:
<?xml version="1.0" encoding="UTF-8"?>
<Configuration>
  <!-- 22734 is the FMAID for left radial artery -->
  <Capability type="Pulse" location="22734">
    <enable>true</enable>
  </Capability>
  <Capability type="IV Access" location="22734">
    <enable>true</enable>
    <!-- internal state was at ‘6’ when ‘Save’ was received -->
    <state>6</state> <!-- Changed from 0 to 6 -->
  </Capability>
</Configuration>
```
