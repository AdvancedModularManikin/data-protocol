# AMM Operational Data Model

## Overview
During AMM operation, data transmitted between modules fall into one of three broad categories: The first is the state
 of the scenario being simulated, which broadly consists of the state of the patient and their environment.
The second category is data that are generated as a result of some event.
Events are frequently caused by a user intervention, but are sometimes triggered by the scenario.
The third category of data is information about the state of the simulator,
 including configuration of Modules and control of the simulation data & progression.

## Simulation Data
For the first category, the long-term goal is to develop an abstract, extensible, engine-agnostic data model for
 patient simulations, including patient physiology and anatomy data, as well as environmental data.
However, AMM version 1 will rely on the BioGears Common Data Model (CDM) for simulation data.
Data element names are the same as those in the
 [BioGears CDM](https://biogearsengine.com/documentation/_c_d_m_tables.html).
 
BioGears data can be accessed by a module using two different modes:
 low frequency Physiology Values and high frequency Physiology Waveforms.
Physiology Values are sent on a best-effort basis, and are not necessarily sent for every BioGears frame.
Physiology Waveforms are delivered reliably and are sent for every BioGears frame.
Both Physiology Values and Waveforms have the same format; their only difference is in their respective Quality of
 Service (QoS) settings for DDS-RTPS.

### `PhysiologyValue` & `PhysiologyWaveform` Topic Fields
#### `simulation_time`
Value of the simulated clock, in milliseconds since UTC Unix epoch.
Because this is tightly coupled to the simulated physiology,
 the simulated clock must be managed by the physiology engine.
When a scenario is loaded, a starting time shall be part of the physiology engine configuration.

#### `timestamp`
Real-world timestamp of when Topic value was updated, in milliseconds since UTC Unix epoch.

#### `name`
Name of the data element, taken from the [BioGears CDM](https://biogearsengine.com/documentation/_c_d_m_tables.html).
[TODO: Add more detail about how the 'nodepath' names are generated.]

This field is used as a DDS Topic Key.

#### `value`
The numerical value of the data.

#### `unit`
The units for the value.

### Environmental Data
For AMM version 1, all environmental data is defined, accessed, and controlled through BioGears,
 using the same pathways as physiology data.
 
## Event Data
Broadly speaking, Events occur when “something happens” during the simulation.
The most obvious example of Events are interventions taken by a practitioner while treating the patient.

When a Module detects that an event has occurred, it publishes an Event Record.
Based on the data included in the Event Record, one or more Modules may publish additional data generated by the event,
 such as a change to physiology or a performance assessment.
Each Event Record has a unique ID that is referenced by all other data generated from the event.

For an Advanced Modular Manikin to respond to an event, two things must happen: a Module must publish an Event Record,
 and one or more Modules must publish data generated from the event.
This generated data comes in three categories:
 a change to physiology (e.g. a hemorrhage),
 an assessment of how the event was performed,
 and a change to what information is rendered by modules.
Data from any of these categories may be generated from an Event Record.
These generated data may be published by Modules other than the publisher of the Event Record, when appropriate.

In some cases, an Event Record may contain information provided by multiple Modules,
 such as an instrument that can sense when it’s used, but cannot sense where.
In such cases, Modules shall utilize the Event Fragment Protocol, described below, to combine data from multiple
 sources into a single Event Record.

### Event Records
These data are published primarily in order to review “what happened” over the course of a simulation.
They do not directly influence the behavior of an AMM during operation,
 but serve as a reference for the data that does cause direct influence.

### `EventRecord` Topic Fields
In order for a Module to interact with the rest of the manikin, it needs to publish and/or subscribe to this Topic.
#### `id`
UUID of the Event. This is used as a reference by other AMM Topics to link them to a specific event.

#### `timestamp`
Real-world timestamp of when the Event was recorded, in milliseconds since UTC Unix epoch.

#### `location`
Where the event occurred. For AMM version 1, this value is restricted to the body of the patient.
The allowed values for `location` those described by the
 [Foundational Model of Anatomy](http://sig.biostr.washington.edu/projects/fm/AboutFM.html) (FMA).
The data type for the `location` field consists of the numeric FMAID and canonical name, as described by FMA.

#### `agent_type`
The category of entity that caused the event.
The value shall be one of the following: `LEARNER`, `INSTRUCTOR`, `SCENARIO`, `PHYSIOLOGY`

The `LEARNER` and `INSTRUCTOR` types indicate the event was caused by a user action.
If an Instructor is triggering an event on behalf of the Learner (e.g. administering a drug via a tablet interface),
 the `agent_type` shall be `INSTRUCTOR` in order to uniquely identify which individual triggered the Event Record.
The `SCENARIO` type indicates the event was triggered by the Scenario, either via run-time scripting, or as part of
 initial patient state.
The `PHYSIOLOGY` type indicates the event was triggered by the patient physiology crossing a pre-defined threshold
 and entering into a specific state, as determined by the physiology Module.

#### `agent_id`
UUID for the entity that caused the event.

For the `LEARNER` and `INSTRUCTOR` agent types, the `agent_id` value shall uniquely correspond to the individual who
 triggered the event.
For the `SCENARIO` agent type, the `agent_id` value shall be the `module_id` value of the Module evaluating the
 Scenario script and triggering the Event.
For the `PHYSIOLOGY` agent type, the `agent_id` value shall be the `module_id` value of the physiology Module
 triggering the Event.
 
In the common case where a Module cannot uniquely identify the individual who triggered the Event, Modules shall
 follow the Event Fragment Protocol, described below, with an initial value of `null` for the `agent_id`.
Modules should always be able to differentiate `agent_type`, based on the presumed user role in the educational
 encounter.
 
#### `type`
A word or concise phrase describing the precise category of the Event. The `type` field is provided as a convenient
 way for Modules to filter Event Records without having to parse the XML of the `data` field, below.

#### `data`
An XML document containing the data describing the event details.
`data` entries shall conform to the appropriate entry in the [Event Types Glossary](glossaries/Event_Type) maintained
 in this repository.
See below for further details.
This field shall have XML version & encoding of `<?xml version="1.0" encoding="UTF-8"?>`.

### Event Record Data Types
While the format of Events Records has fixed metadata (needed for DDS),
 the actual `data` content of the Event Record depends on the `type` of the event.
The Event Record metadata already includes time, location, and agent,
 so the `data` field needs to encapsulate only information specific to the `type` of event that occurred.
 
The structure of the `data` field for each Event `type` is maintained in the
 [Event Types Glossary](glossaries/Event_Type) in this repository.
While no list of Event `types` and their associated `data` formats could be exhaustive,
 Modules must use a shared lexicon in order to interoperate.
As such, Module developers should attempt to conform to the Event types defined here, if possible.
New Event types will be added to this glossary as needed, though the acceptance criteria and cadence of additions
 (and associated 'point' releases of the AMM standard) has yet to be determined.

#### Naming Conventions
Where possible, Event `type`s shall have names that are concise and familiar to those with a medical background.
`data` formats are exclusively XML (1.0, UTF-8 encoding) and shall consist of a single tag, `EventRecord`,
 with a single attribute, `name`, which shall contain the same value as the Event Record `type` field.
Child tags of the `EventRecord` tag vary according to the Event Record `type`,
 and should be re-used when creating new Event `type`s, where feasible.
 
#### BioGears Patient Events
For the Patient Events generated in BioGears, the `type` field of the Event Record shall be taken from the
 [Patient Event Table in the BioGears CDM](https://biogearsengine.com/documentation/_c_d_m_tables.html#PatientEventTable).
For AMM Version 1.0.X, the Data field shall be left blank (empty string).
As such, BioGears Patient Events do not have a corresponding Glossary entry.

#### BioGears Actions
The BioGears Actions, as listed in the
 [BioGears CDM](https://biogearsengine.com/documentation/physeng.html#ProcessActions), need to have an appropriate
 Event Record created to capture metadata about the Event.
Furthermore, Physiology Modification (see below) messages must be tied to an Event Record.

For these specific Events, the Event Record Type field shall use the appropriate BioGears CDM name,
 including capitalization and spaces.
Additionally, the Data field tags should match those used in the XML definitions of the BioGears Actions.
Specifically, the children of the `EventRecord` tag should match the children tags of the BioGears `Action` tag where
 possible.
Some `Action` tags have additional attributes, and may necessitate additional child tags,
 e.g. [Substance Bolus](glossaries/Event_Type/substance-bolus.xml).

## Physiology Modifications
Whereas Events are the record of 'what happened' during a Scenario, messages published to the `PhysiologyModification`
 Topic contain the details of how the patient's physiology should change in response to a particular Event.
Common examples include drug administration, ventilation, and causing or stopping a hemorrhage.
Because development of an engine-agnostic data model is outside the scope of AMM version 1,
 the BioGears Actions are used directly for this data category.
 
All `PhysiologyModification` messages are tied to a specific Event Record via the `event_id` field,
 and shall only be published when triggered by an `EventRecord` message.

When an `EventRecord` has a `location` value on the body of the patient
 and there is a Module simulating that part of the body,
 that Module is the only Module allowed to publish `PhysiologyModification`s in response to that `EventRecord`.
This restriction is required because there may be local state in the Module that is unknown to the rest of the manikin
 that may impact the physiological reaction to a given Event.

For example, a 'smart syringe' Module can use the Event Fragment Protocol to discover it has been used to perform an
 injected into an arm and then publish the appropriate drug administration Event, but the Module simulating the arm
 must publish the `PhysiologyModification` message, because there could be sufficient swelling in the arm to limit
 the effectiveness of the injection.
 
### `PhysiologyModification` Topic Fields
#### `id`
UUID of the message.

#### `event_id`
The `id` field from the `EventRecord` that triggered the `PhysiologyModification` message.

#### `type` & `data`
Much like `EventRecords` the `type` field is a concise name of the `PhysiologyModification` message, and the `data`
 field is the actual payload describing the changes to be made. These details are tracked in the
 [Physiology Modification Glossary](glossaries/Physiology_Modification).

The `type` and `data` fields of `PhysiologyModification` messages will frequently be nearly identical to those in the
 `EventRecord` that triggered the `PhysiologyModification` message.
However, as mentioned above, there may still be local state in a Module which alters the `data` values between the
 `EventRecord` and the `PhysiologyModification` messages.
Additionally, there can be cases where a particular `type` of `PhysiologyModification` is triggered by a different
 `type` of `EventRecord`.
 
The `data` field shall be an XML document with a version & encoding of `<?xml version="1.0" encoding="UTF-8"?>`.
The `data` field shall have a single root element, `PhysiologyModification`,  which has a single attribute, `type`.

The `type` attribute of the `PhysiologyModification` XML tag shall be identical to the `type` field of the
 `PhysiologyModification` Topic message.
 
## Render Modifications
The `RenderModification` Topic encompasses changes to any of the information being actively rendered by Modules
 during a simulation.
This includes physical findings, placements of medical devices, internal injuries,
 and even the presence or absence of data on a patient monitor due to sensor placement.
Render Modifications do not modify the state of the simulated patient, merely how that state is displayed to the
 practitioners.
 
Not all changes to how the state of the simulated patient is rendered require Render Modifications.
If the information being rendered is derived from physiological values, the rendered state can simply change along
 with changing patient physiology.
For example, if a Module has a 'smart skin' that alters the color of its tissue based on the patient's core body
 temperature, this coloration can change in accordance with changing body temp without the need for Render
 Modification messages.

Much like Physiology Modifications, Render Modifications occur only as a response to an Event,
 and are similarly tied to that event.
 
### `RenderModification` Topic Fields
#### `id`
UUID of the message.

#### `event_id`
The `id` field from the `EventRecord` that triggered the `RenderModification` message.

#### `type` & `data`
As with the `EventRecord` Topic, the `type` and `data` fields of the `RenderModification` are linked and defined in
 the [Render Modification Glossary](glossaries/Render_Modification).
 
The `type` field is a concise name that will be readily understood by medical practitioners.

The `data` field is an XML document describing the details of what is to be rendered,
 and shall have a version & encoding of `<?xml version="1.0" encoding="UTF-8"?>`.
The `data` field shall have a single root element, `RenderModification`, which has a single attribute, `type`.

The `type` attribute of the `RenderModification` XML tag shall be identical to the `type` field of the
 `RenderModification` Topic message.

## Learner Performance Assessments

